# Traefik values for Production environment (AM region)
# Install command:
#   helm upgrade --install agent-ingress traefik/traefik \
#     -n traefik-system \
#     -f values-AM.yaml \
#     --skip-crds

# Force resource names to be "agent-ingress" instead of "agent-ingress-traefik"
fullnameOverride: agent-ingress

image:
  tag: "v3.2"

# Deployment configuration
deployment:
  enabled: true
  replicas: 2

# Port configuration
ports:
  web:
    port: 8000
    exposedPort: 80
    protocol: TCP
    # Configura para aceitar X-Forwarded-For do Load Balancer
    forwardedHeaders:
      trustedIPs:
        - 10.0.0.0/8      # Rede interna do AKS
        - 172.16.0.0/12   # Rede interna
        - 192.168.0.0/16  # Rede interna
  websecure:
    port: 8443
    exposedPort: 443
    protocol: TCP
    tls:
      enabled: true
    # Configura para aceitar X-Forwarded-For do Load Balancer
    forwardedHeaders:
      trustedIPs:
        - 10.0.0.0/8      # Rede interna do AKS
        - 172.16.0.0/12   # Rede interna
        - 192.168.0.0/16  # Rede interna
  metrics:
    port: 9100
    expose:
      default: true
    protocol: TCP

# Providers - Traefik CRD and Gateway API
providers:
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
    allowEmptyServices: true
  kubernetesGateway:
    enabled: true
    statusAddress:
      service:
        name: agent-ingress
        namespace: traefik-system

# GatewayClass configuration
gatewayClass:
  enabled: true
  name: agent-ingress

# Service configuration
service:
  enabled: true
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"
    service.beta.kubernetes.io/azure-pip-name: "pip-agents-orbix-traefik-ipv4-prod"
    service.beta.kubernetes.io/azure-load-balancer-resource-group: "mc_rg-orbix-aks_cluster-aks-orbix_eastus2"
    # Habilita preservação do IP de origem (requer AKS 1.16+)
    service.beta.kubernetes.io/azure-load-balancer-disable-tcp-reset: "true"
  externalTrafficPolicy: Local  # Preserva o IP de origem do cliente

# Logs
logs:
  general:
    level: INFO
    format: json  # Formato JSON para melhor parsing
  access:
    enabled: true
    format: json  # Formato JSON estruturado
    # Campos customizados para logar IP real do cliente
    fields:
      defaultMode: keep
      names:
        ClientAddr: keep          # IP do cliente (será o IP real)
        RequestHost: keep          # Host da requisição
        RequestMethod: keep        # Método HTTP
        RequestPath: keep          # Path da requisição
        RequestProtocol: keep      # Protocolo (HTTP/1.1, etc)
        StatusCode: keep           # Status code da resposta
        Duration: keep             # Duração da requisição
        RouterName: keep           # Nome do router que processou
        ServiceName: keep          # Nome do service backend
        OriginStatus: keep         # Status do backend
      headers:
        defaultMode: keep
        names:
          X-Forwarded-For: keep    # IP real do cliente
          X-Real-IP: keep          # IP real alternativo
          User-Agent: keep         # User agent
          Referer: keep            # Referer

# Métricas
metrics:
  prometheus:
    enabled: true
    entryPoint: metrics

# Dashboard
ingressRoute:
  dashboard:
    enabled: false
    matchRule: PathPrefix(`/dashboard`) || PathPrefix(`/api`)
    entryPoints: ["web"]

# Resources
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "1000m"
    memory: "512Mi"

# PDB
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Security
securityContext:
  capabilities:
    drop: [ALL]
  readOnlyRootFilesystem: true
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532