# Traefik values for Production environment (EU region)
# Install command:
#   helm upgrade --install agent-ingress traefik/traefik \
#     -n traefik-system \
#     -f values-EU.yaml \
#     --skip-crds

# Force resource names to be "agent-ingress" instead of "agent-ingress-traefik"
fullnameOverride: agent-ingress

image:
  tag: "v3.2"

# Deployment configuration
deployment:
  enabled: true
  replicas: 2

# Port configuration
ports:
  web:
    port: 8000
    exposedPort: 80
    protocol: TCP
    # Configura para aceitar X-Forwarded-For do Load Balancer
    forwardedHeaders:
      trustedIPs:
        - 10.0.0.0/8      # Rede interna do AKS
        - 172.16.0.0/12   # Rede interna
        - 192.168.0.0/16  # Rede interna
  websecure:
    port: 8443
    exposedPort: 443
    protocol: TCP
    tls:
      enabled: true
    # Configura para aceitar X-Forwarded-For do Load Balancer
    forwardedHeaders:
      trustedIPs:
        - 10.0.0.0/8      # Rede interna do AKS
        - 172.16.0.0/12   # Rede interna
        - 192.168.0.0/16  # Rede interna
  metrics:
    port: 9100
    expose:
      default: true
    protocol: TCP

# Providers - Traefik CRD and Gateway API
providers:
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
    allowEmptyServices: true
  kubernetesGateway:
    enabled: true
    statusAddress:
      service:
        name: agent-ingress
        namespace: traefik-system

# GatewayClass configuration
gatewayClass:
  enabled: true
  name: agent-ingress

# Service configuration
service:
  enabled: true
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"
    service.beta.kubernetes.io/azure-pip-name: "pip-agents-orbix-traefik-ipv4-prod-eu"
    service.beta.kubernetes.io/azure-load-balancer-resource-group: "MC_rg-orbix-aks-prod-eu_cluster-aks-orbix-prod-eu_germanywestcentral"
    # Habilita preservação do IP de origem (requer AKS 1.16+)
    service.beta.kubernetes.io/azure-load-balancer-disable-tcp-reset: "true"
  externalTrafficPolicy: Local  # Preserva o IP de origem do cliente

# Logs
logs:
  general:
    level: INFO
    format: json
  access:
    enabled: true
    format: json
    fields:
      general:
        defaultMode: drop
        names:
          ClientHost: keep
          RequestMethod: keep
          RequestPath: keep
          RequestProtocol: keep
          DownstreamStatus: keep
          Duration: keep
          ServiceName: keep
      headers:
        defaultMode: drop
        names:
          X-Real-Ip: keep
          User-Agent: keep

# Métricas
metrics:
  prometheus:
    enabled: true
    entryPoint: metrics

# Ping endpoint para health checks
ping:
  enabled: true
  entryPoint: web

# Dashboard
ingressRoute:
  dashboard:
    enabled: false
    matchRule: PathPrefix(`/dashboard`) || PathPrefix(`/api`)
    entryPoints: ["web"]

# Resources
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "1000m"
    memory: "512Mi"

# PDB
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Security
securityContext:
  capabilities:
    drop: [ALL]
  readOnlyRootFilesystem: true
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532